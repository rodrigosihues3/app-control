# ==========================================
# GUÍA DE DESPLIEGUE - CONTROL DE ASISTENCIA
# ==========================================

# 1. PREPARACIÓN DE LA VM
# -----------------------
# Actualizar lista de paquetes
sudo apt update
sudo apt upgrade

# Instalar herramientas base (Git y Docker básico)
# Nota: 'docker-compose' aquí instala la V1 vieja, pero es útil tenerla por si acaso.
sudo apt install docker.io docker-compose git -y

# INSTALAR DOCKER COMPOSE V2 (OBLIGATORIO para evitar errores)
# Crear la carpeta global de plugins:
sudo mkdir -p /usr/lib/docker/cli-plugins

# Descargar el plugin oficial:
sudo curl -SL https://github.com/docker/compose/releases/download/v2.24.6/docker-compose-linux-x86_64 -o /usr/lib/docker/cli-plugins/docker-compose

# Darle permisos de ejecución:
sudo chmod +x /usr/lib/docker/cli-plugins/docker-compose

# Iniciar el servicio Docker (Opcional)
sudo service docker start


# 2. INSTALACIÓN DEL PROYECTO
# ---------------------------
# Clonar repositorio
git clone https://github.com/TU_USUARIO/TU_REPO.git
cd nombre-del-repo
cd backend

# A) Crear el archivo de base de datos vacío (para el volumen)
touch database.sqlite

# B) Crear el archivo de variables de entorno
nano .env

# Volver a la raíz
cd ..


# 3. EJECUCIÓN INICIAL
# --------------------
# Levantar los contenedores
# Usar "docker compose" (con espacio) para usar la V2
sudo docker compose up --build -d

# Inicializar la Base de Datos (Solo la primera vez)
# 1. Crear las tablas
sudo docker compose exec backend npx sequelize-cli db:migrate

# 2. Crear el Admin por defecto
sudo docker compose exec backend npx sequelize-cli db:seed:all


# 4. MANTENIMIENTO Y ACTUALIZACIONES
# ----------------------------------
# Para subir cambios:
# 1. En la PC: git push origin main
# 2. En la VM: git pull origin main

# Reconstruye y reinicia (sin borrar datos)
sudo docker compose up --build -d

# 5. SOLUCIÓN DE PROBLEMAS (Reset total)
# --------------------------------------
# Si hay errores raros de contenedores huérfanos o conflictos:
sudo docker compose down --remove-orphans
sudo docker compose up --build -d
